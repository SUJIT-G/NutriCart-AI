<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Grocery Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- ... existing tags ... -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#10B981">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Google AdMob/AdSense Script (Replace client ID later) -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-XXXXXXXXXXXXXXXX" crossorigin="anonymous"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap');
        
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        
        .checkbox-wrapper input:checked + div {
            background-color: #10B981;
            border-color: #10B981;
        }
        .checkbox-wrapper input:checked + div svg {
            display: block;
        }
        .line-through-transition {
            transition: color 0.2s, text-decoration 0.2s;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800">

    <!-- Navbar -->
    <nav class="bg-white border-b border-slate-200 px-6 py-4 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="bg-emerald-500 text-white p-2 rounded-lg">
                    <i class="fa-solid fa-basket-shopping"></i>
                </div>
                <h1 class="text-xl font-bold text-slate-800 tracking-tight">Grocery<span class="text-emerald-500">AI</span></h1>
            </div>
            <div class="flex gap-2">
                <button onclick="copyToClipboard()" class="hidden md:flex items-center gap-2 px-4 py-2 text-sm font-semibold text-slate-600 bg-slate-100 rounded-lg hover:bg-slate-200 transition">
                    <i class="fa-regular fa-copy"></i> Copy
                </button>
                <button onclick="downloadPDF()" class="flex items-center gap-2 px-4 py-2 text-sm font-semibold text-white bg-slate-800 rounded-lg hover:bg-slate-900 transition shadow-lg shadow-slate-300/50">
                    <i class="fa-solid fa-file-pdf"></i> Save PDF
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-12 gap-8 mt-6">
        
        <!-- LEFT PANEL: Controls -->
        <div class="lg:col-span-4 space-y-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 sticky top-24">
                <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-sliders text-emerald-500"></i> Configuration
                </h2>
                
                <form id="groceryForm" class="space-y-4">
                    <!-- Diet Selector -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Diet Preference</label>
                        <div class="relative">
                            <select id="diet" class="w-full appearance-none bg-slate-50 border border-slate-300 text-slate-700 py-3 px-4 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent">
                                <option value="balanced">Balanced / Standard</option>
                                <option value="keto">Keto (Low Carb)</option>
                                <option value="vegan">Vegan</option>
                                <option value="paleo">Paleo</option>
                                <option value="mediterranean">Mediterranean</option>
                                <option value="budget">Budget Friendly ($50/week)</option>
                                <option value="muscle">High Protein / Muscle Gain</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-slate-500">
                                <i class="fa-solid fa-chevron-down text-xs"></i>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Days</label>
                            <input type="number" id="days" value="7" min="1" max="30" class="w-full bg-slate-50 border border-slate-300 py-3 px-4 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">People</label>
                            <input type="number" id="people" value="2" min="1" max="10" class="w-full bg-slate-50 border border-slate-300 py-3 px-4 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none">
                        </div>
                    </div>

                    <button type="submit" id="generateBtn" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-emerald-500/30 transition transform active:scale-95 flex justify-center items-center gap-2">
                        <span>Generate List</span>
                        <i class="fa-solid fa-wand-magic-sparkles"></i>
                    </button>
                </form>

                <div class="mt-6 p-4 bg-blue-50 rounded-xl text-blue-800 text-sm">
                    <p class="font-semibold"><i class="fa-solid fa-circle-info mr-1"></i> Tip:</p>
                    <p class="opacity-80 mt-1">Select your diet and click generate. The AI will build a categorized shopping list for you.</p>
                </div>
            </div>
        </div>

        <!-- RIGHT PANEL: Results -->
        <div class="lg:col-span-8">
            
            <!-- Loading State -->
            <div id="loading" class="hidden flex-col items-center justify-center h-96 bg-white rounded-2xl border border-dashed border-slate-300">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-500 mb-4"></div>
                <p class="text-slate-500 font-medium">Connecting to Worker AI...</p>
                <p class="text-xs text-slate-400 mt-2">Parsing diet requirements</p>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="flex flex-col items-center justify-center h-96 bg-white rounded-2xl border border-dashed border-slate-300">
                <div class="text-6xl mb-4">ðŸ¥—</div>
                <h3 class="text-xl font-semibold text-slate-700">Ready to plan?</h3>
                <p class="text-slate-500 mt-2">Adjust settings on the left and hit Generate.</p>
            </div>

            <!-- Content Area -->
            <div id="resultContent" class="hidden space-y-6">
                <!-- List Header -->
                <div class="flex justify-between items-end pb-4 border-b border-slate-200">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800">Shopping List</h2>
                        <p id="planDetails" class="text-slate-500 text-sm mt-1">Generated Plan</p>
                    </div>
                    <button onclick="clearList()" class="text-red-500 hover:text-red-600 text-sm font-semibold">Clear</button>
                </div>

                <!-- The Dynamic List -->
                <div id="groceryList" class="grid grid-cols-1 md:grid-cols-2 gap-6 pb-20">
                    <!-- Categories will be injected here -->
                </div>
            </div>

            <!-- Raw Text Fallback (Hidden unless error) -->
            <div id="rawFallback" class="hidden mt-8 p-6 bg-slate-100 rounded-xl border border-slate-200">
                <h3 class="text-sm font-bold text-slate-600 mb-2 uppercase">Raw AI Output</h3>
                <pre id="rawText" class="whitespace-pre-wrap text-xs text-slate-600 font-mono"></pre>
            </div>
        </div>
    </main>

    <!-- JS Application Logic -->
    <script>
        const WORKER_URL = "https://odd-forest-e645.devsujit.workers.dev/generate-list";

        const elements = {
            form: document.getElementById('groceryForm'),
            diet: document.getElementById('diet'),
            days: document.getElementById('days'),
            people: document.getElementById('people'),
            generateBtn: document.getElementById('generateBtn'),
            loading: document.getElementById('loading'),
            emptyState: document.getElementById('emptyState'),
            resultContent: document.getElementById('resultContent'),
            groceryList: document.getElementById('groceryList'),
            planDetails: document.getElementById('planDetails'),
            rawFallback: document.getElementById('rawFallback'),
            rawText: document.getElementById('rawText')
        };

        // --- 1. THE FETCH FUNCTION ---
        elements.form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const diet = elements.diet.value;
            const days = elements.days.value;
            const people = elements.people.value;
            const goal = `Grocery list for ${people} people for ${days} days`;

            // UI Updates
            elements.generateBtn.disabled = true;
            elements.generateBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';
            elements.emptyState.classList.add('hidden');
            elements.resultContent.classList.add('hidden');
            elements.rawFallback.classList.add('hidden');
            elements.loading.classList.remove('hidden');

            try {
                // Fetch from your specific worker
                const response = await fetch(WORKER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ diet: diet, goal: goal })
                });

                if (!response.ok) throw new Error(`Server Error: ${response.status}`);

                // IMPORTANT: Get TEXT first (because your worker returns Markdown, not JSON)
                const textData = await response.text();
                
                // Parse the text into a structured object
                const parsedData = parseMarkdownResponse(textData);

                // Update Header
                elements.planDetails.textContent = `${diet.toUpperCase()} Plan Â· ${days} Days Â· ${people} People`;

                // Render
                renderList(parsedData);

                // Also save raw text just in case parsing misses something
                elements.rawText.textContent = textData;

            } catch (error) {
                console.error(error);
                alert(`Connection Error: ${error.message}. Ensure your Worker allows CORS.`);
                elements.emptyState.classList.remove('hidden');
            } finally {
                elements.loading.classList.add('hidden');
                elements.generateBtn.disabled = false;
                elements.generateBtn.innerHTML = '<span>Generate List</span><i class="fa-solid fa-wand-magic-sparkles"></i>';
            }
        });

        // --- 2. THE PARSER (The Magic Part) ---
        // This turns the text "1. Apple" into a clickable item
        function parseMarkdownResponse(text) {
            const lines = text.split('\n');
            const categories = {};
            let currentCategory = "Essentials"; // Default category

            lines.forEach(line => {
                line = line.trim();
                if (!line) return;

                // Detect Category (Lines ending in ':' or wrapped in '**')
                // Regex looks for **Title** or Title:
                if ((line.includes('**') || line.endsWith(':')) && !line.match(/^\d/)) {
                    // Clean the string
                    currentCategory = line.replace(/\*\*/g, '').replace(/:/g, '').trim();
                    if (!categories[currentCategory]) {
                        categories[currentCategory] = [];
                    }
                } 
                // Detect List Items (1. Item or - Item)
                else if (line.match(/^(\d+\.|-|\*)\s/)) {
                    // Remove the "1. " or "- " part
                    const itemText = line.replace(/^(\d+\.|-|\*)\s/, '').trim();
                    
                    if (!categories[currentCategory]) {
                        categories[currentCategory] = [];
                    }
                    categories[currentCategory].push(itemText);
                }
            });

            return categories;
        }

        // --- 3. RENDER FUNCTION ---
        function renderList(categories) {
            elements.groceryList.innerHTML = '';
            const categoryKeys = Object.keys(categories);

            if (categoryKeys.length === 0) {
                // If parser failed but we have text, show raw text
                elements.rawFallback.classList.remove('hidden');
                elements.resultContent.classList.add('hidden');
                return;
            }

            categoryKeys.forEach(cat => {
                if (categories[cat].length === 0) return;

                const section = document.createElement('div');
                section.className = 'bg-white p-5 rounded-xl shadow-sm border border-slate-100';
                
                const title = document.createElement('h3');
                title.className = 'font-bold text-emerald-600 mb-3 uppercase text-xs tracking-wider border-b border-slate-100 pb-2';
                title.textContent = cat;
                section.appendChild(title);

                const ul = document.createElement('ul');
                ul.className = 'space-y-3';

                categories[cat].forEach((item, index) => {
                    const li = document.createElement('li');
                    const uniqueId = `${cat.replace(/\s/g, '')}-${index}`;
                    
                    li.innerHTML = `
                        <label class="checkbox-wrapper flex items-start gap-3 cursor-pointer group">
                            <input type="checkbox" class="peer sr-only" onchange="toggleItem(this)">
                            <div class="w-5 h-5 mt-0.5 border-2 border-slate-300 rounded flex items-center justify-center transition-colors bg-white">
                                <svg class="w-3 h-3 text-white hidden pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                            </div>
                            <span class="text-slate-700 text-sm peer-checked:text-slate-400 peer-checked:line-through line-through-transition select-none group-hover:text-emerald-700">${item}</span>
                        </label>
                    `;
                    ul.appendChild(li);
                });

                section.appendChild(ul);
                elements.groceryList.appendChild(section);
            });

            elements.resultContent.classList.remove('hidden');
        }

        // --- 4. UTILITIES ---

        function toggleItem(checkbox) {
            // Visual logic handled by CSS peer-checked
        }

        function clearList() {
            elements.resultContent.classList.add('hidden');
            elements.emptyState.classList.remove('hidden');
            elements.rawFallback.classList.add('hidden');
        }

        function downloadPDF() {
            const element = document.getElementById('resultContent');
            if(element.classList.contains('hidden')) {
                alert("Generate a list first!");
                return;
            }

            const opt = {
                margin: 0.5,
                filename: 'My_Grocery_List.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };
            html2pdf().from(element).set(opt).save();
        }

        function copyToClipboard() {
            const items = document.querySelectorAll('span.text-slate-700'); // Select list items
            if(items.length === 0) {
                alert("Nothing to copy!");
                return;
            }
            let text = "ðŸ›’ My Grocery List:\n\n";
            items.forEach(span => {
                text += `- ${span.innerText}\n`;
            });
            
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.querySelector('button[onclick="copyToClipboard()"]');
                const original = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-check"></i> Copied!';
                setTimeout(() => btn.innerHTML = original, 2000);
            });
        }
    </script>
    <!-- Place this inside <main> or at the bottom of the page -->
<div class="w-full h-auto my-4 flex justify-center items-center bg-gray-100 border border-gray-200 rounded-lg overflow-hidden">
    <!-- Replace this comment with your AdMob/AdSense Unit Code -->
    <p class="text-xs text-gray-400 py-4">Advertisement Area</p>
    
    <!-- Example Ad Unit Code -->
    <!--
    <ins class="adsbygoogle"
         style="display:block"
         data-ad-client="ca-pub-XXXXXXXXXXXXXXXX"
         data-ad-slot="1234567890"
         data-ad-format="auto"
         data-full-width-responsive="true"></ins>
    <script>
         (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
    -->
</div>
</body>

</html>
